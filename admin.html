<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Panel Admin - Sabor Apasionante</title>

<style>
body {
  margin: 0;
  background: #0d0d0d;
  font-family: Poppins, Arial;
  color: white;
}

header {
  background: #1a1a1a;
  padding: 18px;
  text-align: center;
  font-size: 1.8rem;
  font-weight: 900;
  letter-spacing: 1px;
  color: #fede00;
  box-shadow: 0 0 25px #000;
}

.dashboard {
  padding: 20px;
}

/* Tarjetas de estad√≠sticas */
.stats {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

.stat {
  flex: 1;
  min-width: 160px;
  padding: 15px;
  border-radius: 12px;
  background: #111;
  border: 1px solid #333;
  text-align: center;
}

.stat h2 {
  font-size: 2rem;
  color: #fede00;
  margin: 0;
}

.stat p {
  margin: 5px 0 0 0;
  font-size: 0.9rem;
}

/* PEDIDOS */
.pedido {
  background: #111;
  border-radius: 12px;
  border: 1px solid #444;
  padding: 15px;
  margin-bottom: 15px;
  transition: transform .2s;
}

.pedido:hover {
  transform: scale(1.02);
  box-shadow: 0 0 20px rgba(255,230,0,.2);
}

.pedido h3 {
  margin: 0;
  color: #fede00;
}

.product-list {
  margin-top: 8px;
  padding-left: 15px;
}

.estado {
  font-weight: bold;
  font-size: 1rem;
  padding: 6px 12px;
  border-radius: 8px;
  display: inline-block;
  margin-top: 8px;
  text-transform: uppercase;
}

.estado.pendiente { background:#ff4444; }
.estado.preparando { background:#ff9f1c; }
.estado.listo { background:#00c4ff; }
.estado.entregado { background:#2ecc71; }

/* Select */
select {
  margin-top: 10px;
  padding: 8px;
  background: #222;
  border: 1px solid #555;
  color: white;
  border-radius: 8px;
}

/* Historial */
#historial {
  margin-top: 25px;
}

.hist-dia {
  background: #111;
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 15px;
  border: 1px solid #333;
}

.hist-title {
  font-weight: bold;
  color: #fede00;
  margin-bottom: 5px;
}
</style>
</head>

<body>

<header>üìä Panel Administrativo - Sabor Apasionante</header>

<div class="dashboard">

  <!-- ESTAD√çSTICAS -->
  <div class="stats">
    <div class="stat">
      <h2 id="cPendientes">0</h2>
      <p>Pendientes</p>
    </div>

    <div class="stat">
      <h2 id="cPreparando">0</h2>
      <p>Preparando</p>
    </div>

    <div class="stat">
      <h2 id="cListo">0</h2>
      <p>Listos</p>
    </div>

    <div class="stat">
      <h2 id="cEntregado">0</h2>
      <p>Entregados</p>
    </div>
  </div>

  <!-- PEDIDOS -->
  <h2 style="color:#fede00">Pedidos del D√≠a</h2>
  <div id="pedidos"></div>

  <!-- HISTORIAL -->
  <h2 style="color:#fede00;margin-top:35px;">üìÅ Historial por Fecha</h2>
  <div id="historial"></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="admin.js"></script>

function cargarPedidos() {
  fetch(API)
    .then(r => r.json())
    .then(data => {
      renderPedidos(data);
      renderStats(data);
      renderHistorial(data);
    });
}

function renderStats(lista) {
  document.getElementById("cPendientes").textContent =
    lista.filter(p=>p.estado=="Pendiente").length;
  document.getElementById("cPreparando").textContent =
    lista.filter(p=>p.estado=="Preparando").length;
  document.getElementById("cListo").textContent =
    lista.filter(p=>p.estado=="Listo").length;
  document.getElementById("cEntregado").textContent =
    lista.filter(p=>p.estado=="Entregado").length;
}

function renderPedidos(lista) {
  const cont = document.getElementById("pedidos");
  cont.innerHTML = "";

  lista = lista.filter(p => !p.estado.includes("Archivado"));

  lista.forEach(p => {
    let productosHTML = p.productos.map(
      x => `<li>${x.nombre} - $${x.precio.toLocaleString()}</li>`
    ).join("");

    cont.innerHTML += `
      <div class="pedido">
        <h3>Pedido #${p.id}</h3>
        <p><b>Cliente:</b> ${p.nombre}</p>
        <p><b>Mesa:</b> ${p.mesa}</p>
        <p><b>Total:</b> $${p.total.toLocaleString()}</p>

        <ul class="product-list">${productosHTML}</ul>

        <div class="estado ${p.estado.toLowerCase()}">${p.estado}</div>

        <select onchange="cambiarEstado(${p.id}, this.value)">
          <option disabled selected>Cambiar estado‚Ä¶</option>
          <option>Pendiente</option>
          <option>Preparando</option>
          <option>Listo</option>
          <option>Entregado</option>
        </select>
      </div>
    `;
  });
}

/* CAMBIAR ESTADO */
function cambiarEstado(id, nuevoEstado) {
  fetch(API + "/" + id, {
    method:"PUT",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ estado: nuevoEstado })
  }).then(() => cargarPedidos());
}

/* HISTORIAL POR FECHAS */
function renderHistorial(lista) {
  const cont = document.getElementById("historial");
  cont.innerHTML = "";

  // Agrupar por fecha
  const grupos = {};

  lista.forEach(p => {
    const fecha = p.createdAt.split("T")[0];
    if (!grupos[fecha]) grupos[fecha] = [];
    grupos[fecha].push(p);
  });

  Object.keys(grupos).sort().reverse().forEach(fecha => {
    let html = "";

    grupos[fecha].forEach(p => {
      html += `
        <div>- Pedido #${p.id} ‚Üí ${p.estado} ($${p.total.toLocaleString()})</div>
      `;
    });

    cont.innerHTML += `
      <div class="hist-dia">
        <div class="hist-title">${fecha}</div>
        ${html}
      </div>
    `;
  });
}

setInterval(cargarPedidos, 3000);
cargarPedidos();
</script>

</body>
</html>
